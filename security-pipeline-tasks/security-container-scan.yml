parameters:
- name: fullImageUri
  type: string
- name: severity
  type: string
  default: ""
- name: ignore-unfixed
  type: boolean 
  default: false
  
steps:
- script: |
    mkdir $(Agent.TempDirectory)/trivy -m 777

    cmd="docker run --rm -v "$(Agent.TempDirectory)/trivy:/report" aquasec/trivy:latest image "
    if [ "${{ parameters.severity }}" != "" ]
    then
        cmd+="--severity "${{ parameters.severity }}" "
    fi

    if [ "${{ parameters.ignore-unfixed }}" ]
    then
        cmd+="--ignore-unfixed "
    fi

    cmd+="-f sarif -o /report/trivy.sarif "${{ parameters.fullImageUri }}""

    eval $cmd
    sudo chmod 755 $(Agent.TempDirectory)/trivy/trivy.sarif || true
  displayName: 'Scan image'
  continueOnError: false

- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Agent.TempDirectory)/trivy'
    contents: "*.sarif" 
    targetFolder: $(Agent.TempDirectory)/sast-results/trivy/

- task: DeleteFiles@1
  displayName: 'Remove unneeded files'
  inputs:
    SourceFolder: '$(Agent.TempDirectory)'
    contents: "$(Agent.TempDirectory)/trivy/*.sarif"