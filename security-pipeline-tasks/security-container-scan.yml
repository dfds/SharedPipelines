parameters:
- name: fullImageUri
  type: string
- name: failOnCVSS
  type: number
  default: 9.9
- name: ignoreUnfixed
  type: boolean 
  default: true
  
steps:
- script: |
    mkdir $(Agent.TempDirectory)/trivy -m 777
    
    cmd="docker run --rm -v "$(Agent.TempDirectory)/trivy:/report" -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image "
    if [[ "${{ parameters.ignoreUnfixed}}" == "true" ]]; then
    then
        cmd+="--ignore-unfixed "
    fi

    cmd+="-f sarif -o /report/trivy.sarif "${{ parameters.fullImageUri }}" "
    eval $cmd
    exitCode=$?
    if [ $(cat $(Agent.TempDirectory)/trivy/trivy.sarif | jq '.runs[].tool.driver.rules[].properties | select(."security-severity" >= "${{ parameters.failOnCVSS }}") | ."security-severity"' | wc -l ) -gt 1 ] ; then
      exit 1
    fi
    exit $exitCode
  displayName: 'Scan image'
  condition: succeededOrFailed()

- script: | 
    sudo chmod 755 $(Agent.TempDirectory)/trivy/trivy.sarif
  displayName: Update File
  continueOnError: true
  condition: succeededOrFailed()

- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Agent.TempDirectory)/trivy'
    contents: "*.sarif" 
    targetFolder: $(Agent.TempDirectory)/sast-results/trivy/
  continueOnError: true
  condition: succeededOrFailed()

- task: DeleteFiles@1
  displayName: 'Remove unneeded files'
  inputs:
    SourceFolder: '$(Agent.TempDirectory)'
    contents: "$(Agent.TempDirectory)/trivy/*.sarif"
  continueOnError: true
  condition: succeededOrFailed()