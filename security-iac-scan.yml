parameters:
- name: sourceDirectory21
  type: string
  default: $(Build.SourcesDirectory)

steps:
- script: echo building $(Build.BuildNumber) with ${{ parameters.sourceDirectory21 }}
- script: |
    mkdir $(Agent.TempDirectory)/tfsec -m 777
    docker pull aquasec/tfsec:latest
    ${{ parameters.image }}
    echo ${{ parameters['sourceDirectory21'] }} 
    echo ${{ parameters.sourceDirectory21 }}
    echo ${{ parameters.sourceDirectory21 }} + ":/src"
    sourceDir="${{ parameters.sourceDirectory21 }}:/src"
    echo "$sourceDir"
    docker run --rm -v "$sourceDir" -v "$(Agent.TempDirectory)/tfsec:/report"  aquasec/tfsec:latest --format="sarif" --out="/report/tfsec-scan.sarif" /src
    sudo chmod 755 $(Agent.TempDirectory)/tfsec/tfsec-scan.sarif
  displayName: Run TF-Sec
  continueOnError: false

- task: CopyFiles@2
  inputs:
    SourceFolder: '$(Agent.TempDirectory)/tfsec'
    contents: "*.sarif" 
    targetFolder: $(Agent.TempDirectory)/sast-results/tfsec/

- task: DeleteFiles@1
  displayName: 'Remove unneeded files'
  inputs:
    SourceFolder: '$(Agent.TempDirectory)'
    contents: "$(Agent.TempDirectory)/tfsec/*.sarif" 